---
title: "Final Project"
output: html_document
date: "2023-11-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(gplots)
library(maps) 
library(dplyr)  
library(ggmap)
library(lubridate)
library(ggthemes)
library(RColorBrewer) 
library(sf)

```

```{r}

load('LAPOP.rda')
LAPOP <- da36562.0001
rm(da36562.0001)

```

```{r}
SouthAmerica <- LAPOP %>% 
  filter(PAIS %in% c("(17) Argentina", "(10) Bolivia", "(08) Colombia", "(15) Brazil", "(12) Paraguay", "(14) Uruguay", "(11) Peru", "(13) Chile", "(09) Ecuador", "(16) Venezuela", "(27) Suriname")) %>% 
  mutate(PAIS = substr(PAIS, 6, 20))

```

```{r}
# HUMAN RIGHTS (To what extent do you think that citizens' basic rights are well protected by the political system of country?) (1= not at all, 7= a lot)

SouthAmericaB3 <- SouthAmerica %>% 
  select(YEAR, PAIS, B3) %>% 
  drop_na() %>% 
  group_by(PAIS) %>%
  mutate(total_resp_b3 = n()) %>% 
  filter( B3 >= 5) %>% 
  mutate(total_positive_b3 = n()) %>% 
  distinct(PAIS, .keep_all = TRUE) %>% 
  mutate(percent_good_b3 = 100 * total_positive_b3 / total_resp_b3) 

SouthAmericasf <- read_sf("vc965bq8111") %>%
  group_by(name) %>%
  summarise(geometry = st_combine(geometry)) %>%
  mutate(name = stringr::str_to_lower(name))
  

(SouthAmericasf %>% left_join(SouthAmericaB3 %>% mutate(PAIS = stringr::str_to_lower(PAIS)),by = c('name' = 'PAIS')) %>% 
  ggplot() +
  geom_sf(aes(fill = percent_good_b3)) +
  theme_map() +
  theme(legend.background = element_blank()) +
  theme(legend.position = "right")
 ) %>% plotly::ggplotly()

SouthAmericaB3 %>% 
  arrange(desc(percent_good_b3))

#  labs(title = "How Many South Americans   ", subtitle = "Respondents were asked: To what extent do you think that citizens' basic rights are well protected by the political system of country?", fill = "percent of respondants who answered that the political system highly protects their basic rights. % of Respondents with a Positive View of Basic Rights' Protection") 
```

```{r}
# LIFE SATISFACTION (In general how satisfied are you with your life?) (1 = very satisfied, 4 = very dissatisfied)

SouthAmericaLS3 <- SouthAmerica %>% 
  select(YEAR, PAIS, LS3) %>% 
  drop_na() %>% 
  group_by(PAIS) %>%
  mutate(LS3num = fct_recode(LS3, "1" = "(1) Very Satisfied", "2" = "(2) Somewhat Satisfied", "3" = "(3) Somewhat Dissatisfied", "4" = "(4) Very Dissatisfied")) %>%
  mutate(total_resp_country = n()) %>% 
  filter(LS3num == "1") %>% 
  mutate(total_positive_resp = n()) %>% 
  distinct(PAIS, .keep_all = TRUE) %>% 
  mutate(percent_good_ls3 = 100 * total_positive_resp / total_resp_country) 

SouthAmericasf <- read_sf("vc965bq8111") %>%
  group_by(name) %>%
  summarise(geometry = st_combine(geometry)) %>%
  mutate(name = stringr::str_to_lower(name))
  

library(gganimate)
map_anim <- SouthAmericasf %>% left_join(SouthAmericaLS3 %>% mutate(PAIS = stringr::str_to_lower(PAIS)),by = c('name' = 'PAIS')) %>% 
  ggplot() +
  theme_map() +
  theme(legend.background = element_blank()) +
  theme(legend.position = "right") +
  geom_sf(aes(fill = percent_good_ls3)) + transition_states(YEAR)

animate(map_anim, nframes = 20, fps = 1,renderer = av_renderer())


SouthAmericaLS3 %>% 
  arrange(percent_good_ls3)
```

```{r}
# DEMOCRACY (Percent of people choosing "Democracy is preferable to any other form of government" and not "authoritarian " "it doesn't matter") 

SouthAmericaDEM2 <- SouthAmerica %>% 
  select(YEAR, PAIS, DEM2) %>% 
  drop_na() %>% 
  group_by(PAIS) %>% 
  mutate(total_resp_country = n()) %>% 
  filter(DEM2 == "(2) Democracy is preferable to any other form of government") %>% 
  mutate(total_dem2_country = n()) %>% 
  distinct(PAIS, .keep_all = TRUE) %>% 
  mutate(percent_good_dem2 = 100 * total_dem2_country / total_resp_country)

SouthAmericasf <- read_sf("vc965bq8111") %>%
  group_by(name) %>%
  summarise(geometry = st_combine(geometry)) %>%
  mutate(name = stringr::str_to_lower(name))
  
SouthAmericasf %>% left_join(SouthAmericaDEM2 %>% mutate(PAIS = stringr::str_to_lower(PAIS)),by = c('name' = 'PAIS')) %>% 
  ggplot() +
  geom_sf(aes(fill = percent_good_dem2))

SouthAmericaDEM2 %>% 
  select(PAIS, percent_good_dem2) %>% 
  arrange(desc(percent_good_dem2))
```

```{r}
# ECONOMIC SITUATION SOCT1 (How would you describe the country's economic situation?) (Percent of people that chose  "Good" or "Very Good" and not "fair, "bad" "very bad")


#shows NA values for this question (per country)
SouthAmerica %>% 
  select(YEAR, PAIS, SOCT1) %>% 
  group_by(PAIS) %>% 
  mutate(total_resp_country = n()) %>%
  mutate(num_na = sum(is.na(SOCT1))) %>% 
  distinct(PAIS, .keep_all = TRUE)

SouthAmericaSOCT1 <- SouthAmerica %>% 
  select(YEAR, PAIS, SOCT1) %>% 
  drop_na() %>% 
  group_by(PAIS) %>% 
  mutate(total_resp_country = n()) %>% 
  filter(SOCT1 %in% c("(2) Good", "(1) Very Good")) %>% 
  mutate(total_good_country = n()) %>% 
  distinct(PAIS, .keep_all = TRUE) %>% 
  mutate(percent_good_soct1 = 100 * total_good_country / total_resp_country)


SouthAmericasf <- read_sf("vc965bq8111") %>%
  group_by(name) %>%
  summarise(geometry = st_combine(geometry)) %>%
  mutate(name = stringr::str_to_lower(name))
  

SouthAmericasf %>% left_join(SouthAmericaSOCT1 %>% mutate(PAIS = stringr::str_to_lower(PAIS)),by = c('name' = 'PAIS')) %>% 
  ggplot() +
  geom_sf(aes(fill = percent_good_soct1))

SouthAmericaSOCT1 %>% 
  select(PAIS, percent_good_soct1) %>% 
  arrange(desc(percent_good_soct1))
```

```{r}
# scatterplots LS3 x B3:

LS3clean <- SouthAmericaLS3 %>% 
  select(PAIS, percent_good_ls3)

B3clean <- SouthAmericaB3 %>% 
  select(PAIS, percent_good_b3)

left_join(LS3clean, B3clean) %>% 
  ggplot(aes(x=percent_good_b3, y=percent_good_ls3, color = PAIS)) +
  geom_point() 
# change gkyph to name of country


# LS3 x DEM2:

DEM2clean <- SouthAmericaDEM2 %>% 
  select(PAIS, percent_good_dem2)

left_join(LS3clean, DEM2clean) %>% 
  ggplot(aes(x=percent_good_dem2, y=percent_good_ls3, color = PAIS)) +
  geom_point()


# LS3 x SOCT1

SOCT1clean <- SouthAmericaSOCT1 %>% 
  select(PAIS, percent_good_soct1)


left_join(LS3clean, SOCT1clean) %>% 
  ggplot(aes(x=percent_good_soct1, y=percent_good_ls3, color = PAIS)) +
  geom_point()
```

```{r}
#trying to show change over time in answers :)

# Life satisfaction 
LS3_over_time <- SouthAmerica %>% 
  select(YEAR, PAIS, LS3) %>% 
  drop_na() %>% 
  group_by(PAIS, YEAR) %>%
  mutate(LS3num = fct_recode(LS3, "1" = "(1) Very Satisfied", "2" = "(2) Somewhat Satisfied", "3" = "(3) Somewhat Dissatisfied", "4" = "(4) Very Dissatisfied")) %>%
  mutate(total_ls3 = n()) %>% 
  filter(LS3num == "1") %>% 
  mutate(total_good_ls3 = n()) %>% 
  distinct(PAIS, YEAR, .keep_all = TRUE) %>% 
  mutate(percent_good_ls3 = 100 * total_good_ls3 / total_ls3) %>% 
  select(PAIS, YEAR, percent_good_ls3, total_good_ls3, total_ls3)

LS3_over_time %>% 
  ggplot(aes(x=YEAR, y=percent_good_ls3)) +
  geom_point() +
  facet_wrap(~ PAIS)

LS3_over_time %>% 
  ggplot(aes(x=YEAR, y=percent_good_ls3, color=PAIS)) +
  geom_point()


# Gov protects basic rights
B3_over_time <- SouthAmerica %>% 
  select(YEAR, PAIS, B3) %>% 
  drop_na() %>% 
  group_by(PAIS, YEAR) %>%
  mutate(total_b3 = n()) %>% 
  filter(B3 >= 5) %>% 
  mutate(total_good_b3 = n()) %>% 
  distinct(PAIS, YEAR, .keep_all = TRUE) %>% 
  mutate(percent_good_b3 = 100 * total_good_b3 / total_b3) %>% 
  select(PAIS, YEAR, percent_good_b3, total_good_b3, total_b3)

B3_over_time %>% 
  ggplot(aes(x=YEAR, y=percent_good_b3)) +
  geom_point() +
  facet_wrap(~ PAIS)

B3_over_time %>% 
  ggplot(aes(x=YEAR, y=percent_good_b3, color=PAIS)) +
  geom_point()


# Democracy 
DEM2_over_time <- SouthAmerica %>% 
  select(YEAR, PAIS, DEM2) %>% 
  drop_na() %>% 
  group_by(PAIS, YEAR) %>% 
  mutate(total_dem2 = n()) %>% 
  filter(DEM2 == "(2) Democracy is preferable to any other form of government") %>% 
  mutate(total_good_dem2 = n()) %>% 
  distinct(PAIS, YEAR, .keep_all = TRUE) %>% 
  mutate(percent_good_dem2 = 100 * total_good_dem2 / total_dem2) %>% 
  select(PAIS, YEAR, percent_good_dem2, total_good_dem2, total_dem2)

DEM2_over_time %>% 
  ggplot(aes(x=YEAR, y=percent_good_dem2)) +
  geom_point() +
  facet_wrap(~ PAIS)

DEM2_over_time %>% 
  ggplot(aes(x=YEAR, y=percent_good_dem2, color=PAIS)) +
  geom_point()

 
#Economic situation 
SOCT1_over_time <- SouthAmerica %>% 
  select(YEAR, PAIS, SOCT1) %>% 
  drop_na() %>% 
  group_by(PAIS, YEAR) %>% 
  mutate(total_soct1 = n()) %>% 
  filter(SOCT1 %in% c("(2) Good", "(1) Very Good")) %>% 
  mutate(total_good_soct1 = n()) %>% 
  distinct(PAIS, YEAR, .keep_all = TRUE) %>% 
  mutate(percent_good_soct1 = 100 * total_good_soct1 / total_soct1) %>% 
  select(PAIS, YEAR, percent_good_soct1, total_good_soct1, total_soct1)

SOCT1_over_time %>% 
  ggplot(aes(x=YEAR, y=percent_good_soct1)) +
  geom_point() +
  facet_wrap(~ PAIS)

SOCT1_over_time %>% 
  ggplot(aes(x=YEAR, y=percent_good_soct1, color=PAIS)) +
  geom_point()

```

```{r}

# new data set: all 4 questions over time and visuals

questions_over_time <- left_join(LS3_over_time, B3_over_time)
questions_over_time <- left_join(questions_over_time, DEM2_over_time)
questions_over_time <- left_join(questions_over_time, SOCT1_over_time)


questions_over_time %>% 
  ggplot(aes(x=percent_good_ls3, y=percent_good_dem2, color=PAIS)) +
  geom_point() +
  facet_wrap(~ YEAR)

questions_over_time <- questions_over_time %>% 
  mutate(YearCat = cut(YEAR, c(2004,2009,2015), right = FALSE, labels = c('2004-08','2009-14')))

# first half decade
questions_over_time %>% 
  filter(YearCat == "2004-08") %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_dem2, color=YEAR)) +
  geom_text(aes(label =PAIS))

questions_over_time %>% 
  filter(YearCat == "2004-08") %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_soct1, color=YEAR)) +
  geom_text(aes(label =PAIS))


# animated basic rights and life satisfaction over time for all countries!
library(gganimate)
pp_anim <- questions_over_time %>% 
  #filter(YearCat == "2004-08") %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_b3, color=PAIS)) +
  geom_text(aes(label =PAIS)) + 
  geom_hline(yintercept = 40) +
  geom_vline(xintercept = 35) + theme_classic() + transition_states(YEAR)

animate(pp_anim, nframes = 20, fps = 1,renderer = av_renderer())


# animated dem2 and life satisfaction over time for all countries!
library(gganimate)
pp_anim <- questions_over_time %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_dem2, color=PAIS)) +
  geom_text(aes(label =PAIS)) + 
  geom_hline(yintercept = 40) +
  geom_vline(xintercept = 50) + theme_classic() + transition_states(YEAR)

animate(pp_anim, nframes = 20, fps = 1,renderer = av_renderer())


# animated soct1 and life satisfaction over time for all countries!
library(gganimate)
pp_anim <- questions_over_time %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_soct1, color=PAIS)) +
  geom_text(aes(label =PAIS)) + 
  geom_hline(yintercept = 40) +
  geom_vline(xintercept = 50) + theme_classic() + transition_states(YEAR)

animate(pp_anim, nframes = 20, fps = 1,renderer = av_renderer())

#if we do this for one country (case study): add geom_path to shwo the journey

# second half decade
questions_over_time %>% 
  filter(YearCat == "2009-14") %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_dem2, color=YEAR)) +
  geom_text(aes(label =PAIS))

questions_over_time %>% 
  filter(YearCat == "2009-14") %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_soct1, color=YEAR)) +
  geom_text(aes(label =PAIS))

questions_over_time %>% 
  filter(YearCat == "2009-14") %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_b3, color=YEAR)) +
  geom_text(aes(label =PAIS))


#pivot longer:
questions_over_time %>% 
  select(YEAR, PAIS, percent_good_ls3, percent_good_b3, percent_good_dem2, percent_good_soct1, YearCat) %>% 
  pivot_longer(3:6, names_to = "Question", values_to = "Percent Good", values_drop_na = FALSE) %>% 
  filter(PAIS == "Venezuela") %>% 
  ggplot(aes(x=`Percent Good`, fill =Question)) +
  geom_density() +
  facet_grid(~YearCat)


questions_over_time %>% 
  select(YEAR, PAIS, percent_good_ls3, percent_good_b3, percent_good_dem2, percent_good_soct1, YearCat) %>% 
  pivot_longer(3:6, names_to = "Question", values_to = "Percent Good", values_drop_na = FALSE) %>% 
  filter(PAIS == "Bolivia") %>% 
  ggplot(aes(x=`Percent Good`, fill =Question)) +
  geom_density() +
  facet_grid(~YearCat)


questions_over_time %>% 
  select(YEAR, PAIS, percent_good_ls3, percent_good_b3, percent_good_dem2, percent_good_soct1, YearCat) %>% 
  pivot_longer(3:6, names_to = "Question", values_to = "Percent Good", values_drop_na = FALSE) %>% 
  filter(PAIS == "Venezuela") %>% 
  ggplot(aes(x=YEAR, y=`Percent Good`)) +
  geom_point() + facet_grid(~Question)

questions_over_time %>% 
  select(YEAR, PAIS, percent_good_ls3, percent_good_b3, percent_good_dem2, percent_good_soct1, YearCat) %>% 
  pivot_longer(3:6, names_to = "Question", values_to = "Percent Good", values_drop_na = FALSE) %>% 
  filter(PAIS == "Bolivia") %>% 
  ggplot(aes(x=YEAR, y=`Percent Good`)) +
  geom_point() + facet_grid(~Question)

questions_over_time %>% 
  select(YEAR, PAIS, percent_good_ls3, percent_good_b3, percent_good_dem2, percent_good_soct1, YearCat) %>% 
  pivot_longer(3:6, names_to = "Question", values_to = "Percent Good", values_drop_na = FALSE) %>% 
  filter(PAIS == "Venezuela") %>% 
  ggplot(aes(x=YEAR, y=`Percent Good`, color=Question)) +
  geom_point() + geom_line()

questions_over_time %>% 
  select(YEAR, PAIS, percent_good_ls3, percent_good_b3, percent_good_dem2, percent_good_soct1, YearCat) %>% 
  pivot_longer(3:6, names_to = "Question", values_to = "Percent Good", values_drop_na = FALSE) %>% 
  filter(PAIS == "Bolivia") %>% 
  ggplot(aes(x=YEAR, y=`Percent Good`, color=Question)) +
  geom_point() + geom_line()
```

```{r}
#VENEZUELA 

questions_over_time %>% 
  filter(PAIS == "Venezuela") %>% 
  ggplot(aes(y=percent_good_ls3, x=YEAR, color=percent_good_dem2)) +
  geom_text(aes(label =PAIS))

questions_over_time %>% 
  filter(PAIS == "Venezuela") %>% 
  ggplot(aes(y=percent_good_ls3, x=YEAR, color=percent_good_soct1)) +
  geom_text(aes(label =PAIS))


questions_over_time %>% 
  filter(PAIS == "Venezuela") %>% 
  ggplot(aes(y=percent_good_ls3, x=YEAR, color=percent_good_b3)) +
  geom_text(aes(label =PAIS))

```



# Final Visuals 
### (in progress, but the ones we'll most likley use)

```{r}
# LIFE SATISFACTION map animination (In general how satisfied are you with your life?) (1 = very satisfied, 4 = very dissatisfied)

SouthAmericaLS3 <- SouthAmerica %>% 
  select(YEAR, PAIS, LS3) %>% 
  drop_na() %>% 
  group_by(PAIS) %>%
  mutate(LS3num = fct_recode(LS3, "1" = "(1) Very Satisfied", "2" = "(2) Somewhat Satisfied", "3" = "(3) Somewhat Dissatisfied", "4" = "(4) Very Dissatisfied")) %>%
  mutate(total_resp_country = n()) %>% 
  filter(LS3num == "1") %>% 
  mutate(total_positive_resp = n()) %>% 
  distinct(PAIS, .keep_all = TRUE) %>% 
  mutate(percent_good_ls3 = 100 * total_positive_resp / total_resp_country) 

SouthAmericasf <- read_sf("vc965bq8111") %>%
  group_by(name) %>%
  summarise(geometry = st_combine(geometry)) %>%
  mutate(name = stringr::str_to_lower(name))
  

library(gganimate)
map_anim <- SouthAmericasf %>% left_join(SouthAmericaLS3 %>% mutate(PAIS = stringr::str_to_lower(PAIS)),by = c('name' = 'PAIS')) %>% 
  ggplot() +
  theme_map() +
  theme(legend.background = element_blank()) +
  theme(legend.position = "right") +
  geom_sf(aes(fill = percent_good_ls3)) + transition_states(YEAR)

animate(map_anim, nframes = 20, fps = 1,renderer = av_renderer())


# Animated basic rights and life satisfaction over time for all countries! - Inbal
library(gganimate)
pp_anim <- questions_over_time %>% 
  #filter(YearCat == "2004-08") %>% 
  ggplot(aes(y=percent_good_ls3, x=percent_good_b3, color=PAIS)) +
  geom_text(aes(label =PAIS)) + 
  geom_hline(yintercept = 40) +
  geom_vline(xintercept = 35) + theme_classic() + transition_states(YEAR)

animate(pp_anim, nframes = 20, fps = 1,renderer = av_renderer())


# LS3 all countries over time animation - Inbal
library(gganimate)
pp_anim <- questions_over_time %>% 
  select(YEAR, PAIS, percent_good_ls3, percent_good_b3, percent_good_dem2, percent_good_soct1, YearCat) %>% 
  pivot_longer(3:6, names_to = "Question", values_to = "Percent Good", values_drop_na = FALSE) %>% 
  filter(Question == "percent_good_ls3") %>% 
  ggplot(aes(x=YEAR, y=`Percent Good`, color=PAIS)) +
  geom_point() + geom_path() + transition_reveal(YEAR)

animate(pp_anim, nframes = 10, fps = 1,renderer = av_renderer())
```

```{r}
# Scatterplot, facetted by country, LS3 over time - Maya

LS3_over_time%>%
  ggplot(aes(x= YEAR, y=percent_good_ls3)) +
  geom_point(color = "darkmagenta") +
  geom_line(color = "darkmagenta") +
  facet_wrap(~PAIS) +
  labs(x = "Year", y = "Respondents who Reported High Life Satisfaction (%)", title = "Positive Perception of Life Satisfaction Over Time in South America")+
   theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust=.7))
```

```{r}

# The same animation but just Bolivia with geom_path - Flor
library(gganimate)
pp_anim <- questions_over_time %>%
  filter(PAIS == "Bolivia") %>%
  ggplot(aes(y=percent_good_ls3, x=percent_good_b3, group=PAIS)) +
    geom_point() + geom_path(color = "darkmagenta") +
  #geom_text(aes(label =PAIS)) +
  theme_classic() +
  labs(title = "Bolivia's High Life Satisfaction and Govt. Protection of Basic Rights", subtitle = "From 2004-2014", x = "Participants who Reported Good Government Protection of Basic Rights (%)" ,y = "Participants who Reported High Life Satisfaction (%)") +
 transition_reveal(YEAR)
animate(pp_anim, nframes = 20, fps = 1,renderer = av_renderer())


# Scatterplot of Bolivia with all 4 questions over time - Flor
questions_over_time_Bolivia <- questions_over_time
colnames(questions_over_time_Bolivia)[colnames(questions_over_time_Bolivia) == "percent_good_ls3"] <- "High life satisfaction"
colnames(questions_over_time_Bolivia)[colnames(questions_over_time_Bolivia) == "percent_good_b3"] <- "Govt. protects basic rights"
colnames(questions_over_time_Bolivia)[colnames(questions_over_time_Bolivia) == "percent_good_dem2"] <- "Democracy most preferable"
colnames(questions_over_time_Bolivia)[colnames(questions_over_time_Bolivia) == "percent_good_soct1"] <- "Good economic situation"
questions_over_time_Bolivia %>%
  select(c("YEAR", "PAIS", "Good economic situation", "Govt. protects basic rights", "Democracy most preferable",  "High life satisfaction", "YearCat")) %>%
  pivot_longer(3:6, names_to = "Categories", values_to = "Percent Good", values_drop_na = FALSE) %>%
  filter(PAIS == "Bolivia") %>%
  ggplot(aes(x=YEAR, y=`Percent Good`, color=Categories)) +
  geom_point() + geom_line() +
  labs(title = "Bolivia's Positive Perceptions", subtitle = "Life Satisfaction, Democracy, Basic Rights, and the Economy From 2004 - 2014", x= "Year", y= "Participants with positive response (%)") +
  theme_classic() + scale_color_brewer(palette = "Pastel2") +
  theme(plot.title = element_text(face = "bold"))

```

